let e=function(e){let n=e.slice(e.indexOf("?")+1).split("&"),t={};return n.map((e=>{let[n,r]=e.split("=");t[n]=decodeURIComponent(r)})),t}(document.URL);console.log(e);let n="/items/timecodes";var t={data:()=>({media:{src:e.mediafile,focusOnSecond:e.second,controls:!0,height:"200"},times:null}),inject:["system"],mounted(){console.log(this.system),this.loadItems()},methods:{loadItems(){this.system.api.get(`${n}?filter={"mediafile":{"_eq":"${this.media.src}" }}&sort[]=second`).then((e=>{console.log(e),this.times=e.data.data}))},captureTime(){var e=String(player.currentTime).toHHMMSS();if(null!=document.getElementById("inp"+e))return;let t={id:null,mediafile:this.media.src,tempImage:s(player),screenshot:null,second:player.currentTime,timestring:e,description:""};this.times.push(t);var i=this.times[this.times.length-1];const o=r(t.tempImage),a=new FormData;a.append("img",o,o.name);this.system.api.post("/files",a,{headers:{"Content-Type":"multipart/form-data"}}).then((r=>{console.log("file Uploaded. Result:",r);let s=r.data.data.id;this.system.api.patch("/files/"+s,{folder:"33da7cc5-6d77-4522-9321-19e51bb5f854"}),t.screenshot=s,console.log(t),this.system.api.post(n,t).then((function(e){let n=e.data.data.id;i.id=n,console.log("new Timecode uploaded")})).then((()=>{setTimeout((function(){document.getElementById("inp"+e).focus()}),100)}))}))},inputFocused(e,n){document.getElementById("inp"+e.timestring).focus(),player.currentTime=parseInt(e.second)},sendDescription(e,t){console.log("Send Description",t),this.system.api.patch(n+"/"+e.id,{description:e.description}).then((e=>{console.log("Desc. sent")}))},deleteTimecode(e){this.system.api.delete(n+"/"+e.id).then((e=>{colsole.log(e)}))}}};const r=(e,n)=>{const t=e.split(","),r=t[0].match(/:(.*?);/)[1],s=atob(t[1]);let i=s.length;const o=new Uint8Array(i);for(;i;)o[i-1]=s.charCodeAt(i-1),i-=1;return new File([o],n,{type:r})};function s(e){var n=document.createElement("canvas");return n.width=320,n.height=180,n.getContext("2d").drawImage(e,0,0,n.width,n.height),n.toDataURL("image/jpeg")}function i(e,n,t,r,s,i,o,a,c,d){"boolean"!=typeof o&&(c=a,a=o,o=!1);const m="function"==typeof t?t.options:t;let l;if(e&&e.render&&(m.render=e.render,m.staticRenderFns=e.staticRenderFns,m._compiled=!0,s&&(m.functional=!0)),r&&(m._scopeId=r),i?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),n&&n.call(this,c(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},m._ssrRegister=l):n&&(l=o?function(e){n.call(this,d(e,this.$root.$options.shadowRoot))}:function(e){n.call(this,a(e))}),l)if(m.functional){const e=m.render;m.render=function(n,t){return l.call(t),e(n,t)}}else{const e=m.beforeCreate;m.beforeCreate=e?[].concat(e,l):[l]}return t}String.prototype.toHHMMSS=function(){var e=parseInt(this,10),n=Math.floor(e/3600),t=Math.floor((e-3600*n)/60),r=e-3600*n-60*t;return n<10&&(n="0"+n),t<10&&(t="0"+t),r<10&&(r="0"+r),n+":"+t+":"+r};const o="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());function a(e){return(e,n)=>function(e,n){const t=o?n.media||"default":e,r=d[t]||(d[t]={ids:new Set,styles:[]});if(!r.ids.has(e)){r.ids.add(e);let t=n.source;if(n.map&&(t+="\n/*# sourceURL="+n.map.sources[0]+" */",t+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n.map))))+" */"),r.element||(r.element=document.createElement("style"),r.element.type="text/css",n.media&&r.element.setAttribute("media",n.media),void 0===c&&(c=document.head||document.getElementsByTagName("head")[0]),c.appendChild(r.element)),"styleSheet"in r.element)r.styles.push(t),r.element.styleSheet.cssText=r.styles.filter(Boolean).join("\n");else{const e=r.ids.size-1,n=document.createTextNode(t),s=r.element.childNodes;s[e]&&r.element.removeChild(s[e]),s.length?r.element.insertBefore(n,s[e]):r.element.appendChild(n)}}}(e,n)}let c;const d={};const m=t;var l=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("private-view",{attrs:{title:"Разметка медиафала"}},[t("div",{attrs:{id:"contols"}},[t("video",{attrs:{crossorigin:"anonymous",id:"player",src:"/assets/"+e.media.src,controls:e.media.controls,height:"200"}}),e._v(" "),t("v-button",{on:{click:e.captureTime}},[e._v("Поставить метку")])],1),e._v(" "),t("div",{attrs:{id:"fragments"}},e._l(e.times,(function(n){return t("form",{key:n.id},[n.screenshot?t("img",{attrs:{src:"/assets/"+n.screenshot,alt:"no image"}}):e._e(),e._v(" "),null==n.screenshot?t("img",{staticClass:"tempImage",attrs:{src:n.tempImage,alt:"no image"}}):e._e(),e._v(" "),t("a",{attrs:{href:"#"},on:{click:function(t){return e.inputFocused(n,t)}}},[e._v(" "+e._s(n.timestring))]),e._v(" "),n.id?t("input",{directives:[{name:"model",rawName:"v-model",value:n.description,expression:"metka.description"}],attrs:{id:"inp"+n.timestring,autofocus:""},domProps:{value:n.description},on:{blur:function(t){return e.sendDescription(n,t)},input:function(t){t.target.composing||e.$set(n,"description",t.target.value)}}}):e._e(),e._v(" "),t("button",{on:{click:function(t){return e.deleteTimecode(n)}}},[e._v("X")])])})),0)])};l._withStripped=!0;var u={id:"metka",name:"Разметка медиафайлов",icon:"box",routes:[{path:"/",component:i({render:l,staticRenderFns:[]},(function(e){e&&e("data-v-3bda3a8a_0",{source:"\n#controls{\n    display:block;\n    max-width: 360px;\n    height: 240px;\n}\n#controls video{\n    height: 200px;\n}\n#fragments{\n    display:block;\n    height: calc(90% - 240px);\n    min-width:400px;\n    overflow:auto;\n}\n.tempImage{border: 1px red solid;}\n#fragments form img\n{\n    display: inline-block;\n    width: 240px;\n}\n",map:{version:3,sources:["C:\\Users\\ipetrov\\Documents\\dev\\exampleDirectus\\my-directus-module\\src\\module.vue"],names:[],mappings:";AACA;IACA,aAAA;IACA,gBAAA;IACA,aAAA;AACA;AACA;IACA,aAAA;AACA;AACA;IACA,aAAA;IACA,yBAAA;IACA,eAAA;IACA,aAAA;AACA;AACA,WAAA,qBAAA,CAAA;AACA;;IAEA,qBAAA;IACA,YAAA;AACA",file:"module.vue",sourcesContent:["    <style type=\"text/css\">\r\n        #controls{\r\n            display:block;\r\n            max-width: 360px;\r\n            height: 240px;\r\n        }\r\n        #controls video{\r\n            height: 200px;\r\n        }\r\n        #fragments{\r\n            display:block;\r\n            height: calc(90% - 240px);\r\n            min-width:400px;\r\n            overflow:auto;\r\n        }\r\n        .tempImage{border: 1px red solid;}\r\n        #fragments form img\r\n        {\r\n            display: inline-block;\r\n            width: 240px;\r\n        }\r\n    </style>\r\n<template>\r\n\t<private-view title=\"Разметка медиафала\">\r\n        <div id=contols>\r\n        <video crossorigin = \"anonymous\" \r\n               id = 'player' \r\n               :src = '\"/assets/\"+media.src' \r\n               :controls = 'media.controls'\r\n               height=200\r\n       ></video>\r\n        \r\n            <v-button @click='captureTime'>Поставить метку</v-button>\r\n        </div>\r\n        <div id='fragments'>\r\n            <form v-for='metka in times' :key=\"metka.id\">\r\n                <img \r\n                     :src='\"/assets/\"+metka.screenshot'\r\n                     alt=\"no image\" v-if=\"metka.screenshot\" />\r\n                <img class='tempImage'\r\n                     :src='metka.tempImage'\r\n                     alt=\"no image\" v-if=\"(metka.screenshot==undefined)\" />\r\n\x3c!--                     :src='metka.screenshot'--\x3e\r\n                <a   @click = 'inputFocused(metka, $event)' href='#'> {{ metka.timestring }}</a>\r\n                <input v-model='metka.description' \r\n                       :id = '\"inp\"+metka.timestring' \r\n                       @blur=\"sendDescription(metka, $event)\"\r\n                       v-if='metka.id'\r\n                       autofocus >\r\n                <button @click=\"deleteTimecode(metka)\">X</button>\r\n            </form>\r\n        </div>\r\n\r\n    </private-view>\r\n</template>\r\n\r\n<script>\r\nlet getQuery = getUrlParams(document.URL);\r\nconsole.log(getQuery);\r\n    \r\nlet TAB = '/items/timecodes';\r\nexport default {\r\n    data(){\r\n        return {\r\n            media: { \r\n            src: getQuery.mediafile,\r\n            focusOnSecond: getQuery.second,\r\n            controls:true,\r\n            height:'200'\r\n           },\r\n            times: null,\r\n        }\r\n    },\r\n    inject: ['system'], // эта переменная даёт доступ к волшебному api при помощи которого можно обмениваться информацией с сервером практически бесшовно\r\n    mounted() {\r\n        console.log(this.system);\r\n        this.loadItems();\r\n    },\r\n    methods: {\r\n        loadItems(){\r\n            this.system.api.get(`${TAB}?filter={\"mediafile\":{\"_eq\":\"${this.media.src}\" }}&sort[]=second`).then((res) => {\r\n                console.log(res);\r\n                this.times = res.data.data;\r\n            });\r\n        },\r\n       /**\r\n         * @brief Захватить время из медиафайла и сохранить его в базу данных\r\n         * @return ничего\r\n         */\r\n        captureTime(){\r\n            var timeSt = String(player.currentTime).toHHMMSS();\r\n            if(document.getElementById('inp'+timeSt)!=undefined)return;\r\n            let newTimecode = {\r\n                id:null,\r\n                mediafile: this.media.src,\r\n                tempImage: getScreenShot(player),\r\n                screenshot:null,\r\n                second: player.currentTime,\r\n                timestring: timeSt,\r\n                description:''\r\n            };\r\n            this.times.push(newTimecode);\r\n            var tm = this.times[this.times.length-1];\r\n            /*\r\n            *\r\n            * Загрузка скриншота\r\n            *\r\n            */\r\n            const fileImg = dataURLtoFile(newTimecode.tempImage);\r\n            \r\n            const formData = new FormData();\r\n            formData.append('img',fileImg,fileImg.name);\r\n            const conf = {\r\n                headers: {'Content-Type': 'multipart/form-data'}\r\n            }\r\n            this.system.api.post('/files',formData,conf)\r\n                .then((res)=>{\r\n                    console.log('file Uploaded. Result:',res);\r\n                    let uuid = res.data.data.id;\r\n                    this.system.api.patch('/files/'+uuid,{\"folder\": '33da7cc5-6d77-4522-9321-19e51bb5f854'});\r\n                    // Отправка остальных данных\r\n                    newTimecode.screenshot = uuid;\r\n                    console.log(newTimecode);\r\n                    this.system.api.post(TAB, newTimecode)\r\n                        .then(function(res){\r\n                            let id = res.data.data.id;\r\n                            tm.id = id; // Осторожно!! Если пересортировать список перед этим, то всё собъётся!\r\n                            console.log('new Timecode uploaded');\r\n                        }).then(()=>{\r\n                            setTimeout(function(){document.getElementById('inp'+timeSt).focus();}, 100); // ждём пока создастся input и переводим на него фокус\r\n                        });\r\n                });\r\n        },  \r\n         /**\r\n         * @brief Сфокусировать курсор на текстовом поле, \r\n                    когда выбран определённый кадр \r\n                    и перевести кадр на нужную позицию в плеере\r\n         * @return ничего\r\n         */\r\n        inputFocused(metka,e){\r\n            document.getElementById( 'inp'+metka.timestring).focus();\r\n            player.currentTime = parseInt(metka.second);\r\n        },\r\n        /**\r\n         * @brief Отправить описание фрагмента на сервер\r\n         * @return ничего\r\n         */\r\n        sendDescription(metka, event){\r\n            console.log('Send Description', event);\r\n            this.system.api.patch(TAB+'/'+metka.id, {description: metka.description})\r\n                .then((res)=>{console.log('Desc. sent');});\r\n        },\r\n        /**\r\n         * @brief Удалить фрагмент\r\n         * @return ничего\r\n         */\r\n        deleteTimecode(metka){\r\n            this.system.api.delete(TAB+'/'+metka.id)\r\n            .then((res)=>{ colsole.log(res)});\r\n        }\r\n    },\r\n    \r\n};\r\n/**\r\n*\r\n* Источник: https://gist.github.com/ibreathebsb/a104a9297d5df4c8ae944a4ed149bcf1\r\n*\r\n*/\r\nconst dataURLtoFile = (dataurl, filename) => {\r\n  const arr = dataurl.split(',')\r\n  const mime = arr[0].match(/:(.*?);/)[1]\r\n  const bstr = atob(arr[1])\r\n  let n = bstr.length\r\n  const u8arr = new Uint8Array(n)\r\n  while (n) {\r\n    u8arr[n - 1] = bstr.charCodeAt(n - 1)\r\n    n -= 1 // to make eslint happy\r\n  }\r\n  return new File([u8arr], filename, { type: mime })\r\n}\r\n/**\r\n * @brief Получить параметры из GET запроса (адреса страницы)\r\n * @param [in] search URL-адрес из которого нужно получть параметры \r\n                после знака ? в формате ключ=значение. \r\n                Например, http://example.com?key1=val&key2=val2\r\n * @return Объект с ключами и значениями\r\n */\r\nfunction getUrlParams(search) {\r\n    let hashes = search.slice(search.indexOf('?') + 1).split('&')\r\n    let params = {}\r\n    hashes.map(hash => {\r\n        let [key, val] = hash.split('=')\r\n        params[key] = decodeURIComponent(val)\r\n    })\r\n    return params;\r\n}\r\n    \r\n/**\r\n * @brief Сохранение скриншота из видео\r\n * @param [in] video - id элемента video на странице, из которого требуется взять скриншот\r\n * @return Изображение в виде строки\r\n */\r\nfunction getScreenShot(video){\r\n    var canvas = document.createElement('canvas');\r\n    canvas.width = 160*2;\r\n    canvas.height = 90*2;\r\n    var context = canvas.getContext('2d');\r\n    context.drawImage(video, 0 , 0, canvas.width, canvas.height);\r\n    var dataURI = canvas.toDataURL('image/jpeg');\r\n//    console.log(dataURI);\r\n    return dataURI;\r\n    \r\n}\r\n\r\n/**\r\n * @brief Добавление функции в объект String - преобразование секунд в строку в формате HH:MM:SS, где HH - часы, MM - минуты, SS - секунды\r\n * @return строка со временем в формате HH:MM:SS\r\n */\r\nString.prototype.toHHMMSS = function () {\r\n    var sec_num = parseInt(this, 10); // don't forget the second param\r\n    var hours   = Math.floor(sec_num / 3600);\r\n    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);\r\n    var seconds = sec_num - (hours * 3600) - (minutes * 60);\r\n\r\n    if (hours   < 10) {hours   = \"0\"+hours;}\r\n    if (minutes < 10) {minutes = \"0\"+minutes;}\r\n    if (seconds < 10) {seconds = \"0\"+seconds;}\r\n    return hours+':'+minutes+':'+seconds;\r\n}\r\n<\/script>"]},media:void 0})}),m,undefined,false,undefined,!1,a,void 0,void 0)}]};export default u;
